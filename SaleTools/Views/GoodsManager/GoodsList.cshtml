
@using Model;
@using Common.Entities;

@{
    ViewBag.Title = "GoodsList";
    var SupplierList = (List<Supplier>)ViewBag.SupplierList;
    var UserTypeList = (List<UserType>)ViewBag.UserTypeList;
    var Resourse = (List<string>)ViewBag.Resourse;

}
<link rel="stylesheet" type="text/css" href="/Content/css/bootstrap.min.css">

<style>
    img {
        width: 80px;
        border: 1px solid #dddddd;
    }
    .box {
        width: 955px;
        height: 80px;
        border: 1px solid #ddd;
        border-top: none;
    }
        .box input {
            float: left;
            margin-left: 10px;
            margin-top: 35px;
        }
</style>
<div class="col_main_hd">
    <h2>
        商品列表
    </h2>
</div>
<div class="col_main_bd">
    <div class="inner">
        <div class="col_main_content">

            <div class="col_main_content">
                <div class="search_bar">
                    <ul class="search_item_list">
                        <li class="search_item">
                            <label>
                                供应商:
                            </label>
                            <div class="item  item_li">
                                <div id="seller_id" class="selectpicker" data-clear="true" data-live="true">
                                    <a href="#" class="clear" style="top:-5px !important;">
                                        <span class="cancel">
                                            ❌
                                        </span>
                                        <span class="sr-only">
                                            Cancel the selection
                                        </span>
                                    </a>
                                    <button data-id="prov" type="button" class="btn btn-lg btn-block btn-default dropdown-toggle">
                                        <span class="placeholder text">
                                            请选择
                                        </span>
                                        <span class="caret">
                                        </span>
                                    </button>
                                    <div class="dropdown-menu">
                                        <div class="live-filtering" data-clear="true" data-autocomplete="true" data-keys="true">
                                            <label class="sr-only" for="input-bts-ex-5">
                                                Search in the list
                                            </label>
                                            <div class="search-box">
                                                <div class="input-group">
                                                    <span class="input-group-addon" id="search-icon5">
                                                        <span class="search">
                                                            🔍
                                                        </span>
                                                        <a href="#" class="fa fa-times hide filter-clear">
                                                            <span class="sr-only">
                                                                Clear filter
                                                            </span>
                                                        </a>
                                                    </span>
                                                    <div style="position: relative; height: 34px; display: block;">
                                                        <input type="text" class="form-control live-search hint" aria-describedby="search-icon5" tabindex="-1" autocomplete="off" style="background-color: transparent; position: absolute;">
                                                        <input type="text" placeholder="Search in the list" id="input-bts-ex-5" class="form-control live-search" aria-describedby="search-icon5" tabindex="1" autocomplete="off" style="background-color: transparent; position: relative;">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="list-to-filter">
                                                <ul class="list-unstyled">
                                                    <li class="optgroup">
                                                        <ul id="J_Seller" class="list-unstyled">
                                                            @foreach (var item in SupplierList)
                                                {
                                                    <li class="filter-item items" data-filter="@item.SupplierCompany" data-value="@item.Id">
                                                        @item.SupplierCompany
                                                    </li>

                                    }


                                                        </ul>
                                                    </li>
                                                </ul>
                                                <div class="no-search-results" style="display: none;">
                                                    <div class="alert alert-warning" role="alert">
                                                        <i class="fa fa-warning margin-right-sm">
                                                        </i> No entry for
                                                        <strong>
                                                            '
                                                            <span>
                                                            </span>
                                                            '
                                                        </strong> was found.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="hidden" name="seller_id" id="Sid" value="0">
                                </div>
                            </div>
                        </li>
                        <li class="search_item">
                            <label>
                                &nbsp;&nbsp;状态:
                            </label>
                            <select name="state" id="state">
                                <option value="0" selected="selected">
                                    全部
                                </option>
                                <option value="-1">
                                    下架
                                </option>
                                <option value="1">
                                    上架
                                </option>
                            </select>
                        </li>
                        <li class="search_item">
                            <label>
                                类目:
                            </label>
                            <div class="item">
                                <div class="wgt_category_select" id="J_CategorySelector" data-fid="0" data-sid="0" data-tid="0">
                                    <div class="wgt_category_select_hd" style="display: none;">
                                        <div class="wgt_category_title">
                                            请选择类目
                                        </div>
                                        <i class="iconfont">
                                            
                                        </i>
                                    </div>
                                    <div class="wgt_category_select_bd">
                                        <div class="wgt_category_select_tabs">
                                            <a class="wgt_category_select_tab cur" href="javascript:;">
                                                一级类目
                                            </a>
                                            <a class="wgt_category_select_tab" href="javascript:;">
                                                二级类目
                                            </a>
                                            <a class="wgt_category_select_tab" href="javascript:;">
                                                三级类目
                                            </a>
                                        </div>
                                        <div class="wgt_category_select_contents">
                                            <div class="wgt_category_select_content wgt_category_select_content_show">
                                            </div>
                                            <div class="wgt_category_select_content">
                                                <dl>
                                                    <dd class="clearfix">
                                                    </dd>
                                                </dl>
                                            </div>
                                            <div class="wgt_category_select_content">
                                                <dl>
                                                    <dd class="clearfix">
                                                    </dd>
                                                </dl>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </li>
                        <!--隐藏sort排序-->
                        <input type="hidden" name="sort" value="">
                        <li class="clearfix">
                        </li>
                        <li class="search_item">
                            <input type="checkbox" value="1" name="notLike"> 不包含
                            <label>
                                关键字:
                            </label>
                            <input type="text" name="search_value" style="height:22px; margin-left:10px;" value="" id="search_value" >
                        </li>
                        <li class="search_item">
                            <label>
                                客户类型:
                            </label>
                            <select name="customer_type" id="customer_type">
                                <option value="">
                                    全部
                                </option>
                                @foreach (var item in UserTypeList)
                    {
                        <option value="@item.TypeId">
                            @item.TypeName
                        </option>

        }
                            </select>
                        </li>

                        <li class="search_item">
                            <button type="submit" onclick="LoadList(1)">
                                搜索
                            </button>
                        </li>
                        @if (Resourse.Contains(ResourceStr.ExportGoods) || Resourse.Contains(ResourceStr.SuperAdmin))
            {
                <li class="search_item">
                    <button type="button" id="goodExport">
                        <a href="#" onclick="exportCSV()" style="color:white">
                            商品导出
                        </a>
                    </button>
                </li>
}
                        <li class="search_item" style="color:#d70000;" id="totalCount">
                            商品总数为:
                        </li>
                        <li class="clearfix">
                        </li>
                    </ul>
                </div>
                <table class="table table_border product_list">
                    <thead class="bg_color">
                        <tr>
                            <th class="center" width="20">
                            </th>
                            <th class="product center" width="200">
                                商品
                            </th>
                            <th class="price center clickSort change" width="60">
                                单价
                                <span class="dot-top clickDot"  sort ="price"></span>
                                <span class="dot-bottom clickDot" sort ="price"></span>

                            </th>
                            <th class="sales_volume center clickSort change" width="80">
                                销量

                            </th>
                            <th class="quantity center clickSort change" width="80">
                                库存

                            </th>

                            <th class="state center" width="130">
                                编辑时间
                                <span class="dot-top clickDot" sort ="edittime"></span>
                                <span class="dot-bottom clickDot" sort ="edittime"></span>

                            </th>
                            <th class="clickSort change">
                                起批量
                                <span class="dot-top clickDot" sort ="mincount"></span>
                                <span class="dot-bottom clickDot" sort ="mincount"></span>

                            </th>
                            <th class="sort center clickSort change">
                                排序
                                <span class="dot-top clickDot" sort ="sortid"></span>
                                <span class="dot-bottom clickDot" sort ="sortid"></span>

                            </th>
                            <th class="total center">
                                操作
                            </th>
                        </tr>
                    </thead>
                    <!-- -->

                </table>
                <div class="box">
                    <input type="checkbox" name="pass[]" id="checkall" >
                    <span>全选</span>
                    <button type="submit" id="btn_text">批量上架</button>
                    <button type="submit" id="btn_down">批量下架</button>
                    <button type="submit" id="btn_del">批量删除</button>
     
                </div>
                <div id="page" class="page_div"></div>
            </div>
        </div>
    </div>
</div>
<input type="hidden" id="sort" value="edittime"/>
<input type="hidden" id="order" value="Desc" />
<script type="text/javascript" src="/Content/js/lib/jquery-1.11.1.min.js"></script>

<script type="text/javascript" src="/Content/js/lib/help.js">
</script>
<script type="text/javascript" src="/Content/js/lib/category_selector/category_selector.js">
</script>
<script type="text/javascript" src="/Content/js/lib/overlay.js">
</script>
<script type="text/javascript" src="/Content/js/lib/select_js/bootstrap-select.js">
</script>
<script type="text/javascript" src="/Content/js/lib/select_js/livefilter.min.js">
</script>
<script type="text/javascript" src="/Content/js/lib/select_js/tabcomplete.min.js">
</script>
<script type="text/javascript" src="/Content/js/lib/paging.js"></script>
<script src="~/Scripts/layer/layer.js"></script>
<script>
    var index = 1;
    LoadList(1);
    $(function () {

    })
    $(".dot-top").click(function () {
        var sort = $(this).attr("sort");
        $("#sort").val(sort);
        $("#order").val("Asc");
        LoadList(index);
    })
    $(".dot-bottom").click(function () {
        var sort = $(this).attr("sort");
        $("#sort").val(sort);
        $("#order").val("Desc");
        LoadList(index);
    })
    $("#J_CategorySelector").CategorySelector({
        afterThdSelect: function (cid) {
            // 品牌信息
            LoadList(1);
        }
    });

    function GetPara() {
        var para = {};
        para.SupplierId = $("#Sid").val();
        para.IsUpShelves = $("#state").val();
        para.fstTypeId = $("input[name='fst_cat_id']").val();
        para.secTypeId = $("input[name='snd_cat_id']").val();
        para.thdTypeId = $("input[name='thd_cat_id']").val();
        para.keyWord = $("#search_value").val();
        para.sort = $("#sort").val();
        para.order = $("#order").val();
        return para;
    }

    function LoadList(pageIndex) {
        index = pageIndex;
        var postData = GetPara();
        postData.index = pageIndex;
        postData.size = 10;
        $.ajax({
            url: "/GoodsManager/GetGoodsList",
            async: false,
            type: "POST",
            data: postData,
            dataType: "json",
            success: function (e) {
                var html = "";
                $(e.ListData).each(function () {
                    html += '<tbody>< tr ><td colspan="10" class="sep_row">&nbsp;</td></tr >'
                    html += '<tr class="product_hd"><th colspan="10">条形码:'
                    html += ' <input type="text" style="width:150px;padding:5px;" class="J_QuickBarCode" data-id="' + this.Id + '" data-bar-code="' + this.BarCode + '" value="' + this.BarCode + '"> 商品ID:' + this.GoodsNum + ' &nbsp;';
                    html += ' <span style="float:right;">' + this.SupplierName + '</span></th></tr>';
                    html += '< tr class="product_bd" ><td class="center"><input type="checkbox" name="pass" value="' + this.Id + '"></td>'
                    html += '<td class="product"><a href="" class="lfloat"><img src="' + this.pic1 + '"></a>';
                    html += ' <div class="title"><a href="">' + this.GoodsTittle + '</a></div></td>';
                    html += '<td class="center">' + GetPrice(this) + '</td>';
                    html += '<td class="center">-</td>';
                    html += '<td class="center">' + this.Stock + '</td>';
                    html += '<td class="center">' + this.LastUpdateTime + '</td>'
                    html += '<td class="center"><input type="text" style="width:60px;text-align:center;" class="J_midSoldNum"   onchange="ChangemidSoldNum(this)" data-id="' + this.Id + '" data-num="' + this.MinCount + '" value="' + this.MinCount + '"></td>';
                    html += '<td class="center"><input type="text" style="width:60px;text-align:center;" class="J_QuickSort" onchange="ChangeQuickSort(this)" data-id="' + this.Id + '" data-sort="' + this.SortId + '" value="' + this.SortId + '"></td>';
                    html += '<td class="center"><a href="/GoodsManager/ShowGoodsInfo?goodId=' + this.Id + '">商品详情</a><br><br>';
                    html += '<a href="/GoodsManager/CopyNew/' + this.Id + '">复制新增</a><br><br>';
                    html += '<a href="/GoodsManager/AddGoods/' + this.Id + '">编辑商品</a><br><br>';
                    var strShelves = "上架";
                    if (this.IsUpShelves) {
                        strShelves = "下架"
                    }
                    html += '<button type="button" class="btn btn_confirm J_UpShelves" data-isShelves="' + this.IsUpShelves + '" data-id="' + this.Id + '">' + strShelves + '</button>';
                    html += '<input type="button" class="delpro btn" value="删除" data-id="' + this.Id + '" style="margin-top:3px;"></td></tr></tbody>';
                });
                $(".product_list").find("tbody").remove();
                $("#totalCount").html("商品总数为:" + e.TotalCount)
                $(".product_list").append(html);
                $("#page").paging({
                    pageNo: pageIndex,
                    totalPage: e.TotalPage,
                    totalSize: e.TotalCount,
                    callback: function (num) {
                        if (pageIndex != num)
                            LoadList(num);
                    }
                })
            }
        })
    }
    function GetPrice(obj) {
        var type = $("#customer_type").val();
        var price = 0;
        switch (type) {
            case "1":
                price = obj.BasePrice;
                break;
            case "2":
                price = obj.PriceForA;
                break;
            case "3":
                price = obj.PriceForB;
                break;
            case "4":
                price = obj.PriceForC;
                break;
            case "5":
                price = obj.PriceForD;
                break;
            case "6":
                price = obj.PriceForLianSuo;
                break;
            default:
                price = obj.BasePrice;
                break;
        }
        return price.toFixed(2);
    }

    $(document).on("click", ".delpro", function () {
        var goodsIds = [];
        goodsIds.push($(this).data("id"));
        DeleteGoods(goodsIds);
    });


    $(document).on("click", ".J_UpShelves", function () {
        var goodsIds = [];
        goodsIds.push($(this).data("id"));
        var isShelves = !$(this).data("isshelves")
        ToggleShelves(goodsIds, isShelves);
    });

    function DeleteGoods(goodsList) {
        layer.confirm('请确认是否删除？', {
            btn: ['取消', '确认'] //按钮
        }, function () {
            layer.closeAll();
        }, function () {

            $.post("/GoodsManager/DeleteGoods", { goodsIds: goodsList }, function (e) {
                if (e) {
                    LoadList(1);
                }
            }, "json");
        });

    }


    function ToggleShelves(goodsList, isShelves) {
        layer.confirm('请确认下架该商品？', {
            btn: ['取消', '确认'] //按钮
        }, function () {
            layer.closeAll();
        }, function () {

            $.post("/GoodsManager/ToggleShelves", { goodsIds: goodsList, isShelves: isShelves }, function (e) {
                if (e) {
                    LoadList(1);
                }
            }, "json");
        });
    }

    function exportCSV() {
        var postData = GetPara();
        var url = "/GoodsManager/ExportGoodInfo?";
        var paraStr = "";
        for (var Key in postData) {
            if (paraStr != "")
                paraStr = paraStr + '&';
            paraStr = paraStr + '' + Key + '=' + postData[Key] + '';
        }
        location.href = url + paraStr;

    }


    $("#checkall").click(function () {
        var checked = $(this).prop("checked");
        var ids = [];
        $.each($("input:checkbox"), function () {
            $(this).prop("checked", checked);
        });
    });
    $("#btn_text").click(function () {
        var ids = [];
        $($("input[name='pass']:checked")).each(function () {
            ids.push($(this).val());
        })
        if (ids.length < 1) {
            layer.msg("您还未选择任何项！", { icon: 2 });
            return;
        }
        DealWithCounts("批量上架", "ToggleShelves", ids, true);
    })


    $("#btn_down").click(function () {
        var ids = [];
        $($("input[name='pass']:checked")).each(function () {
            ids.push($(this).val());
        })
        if (ids.length < 1) {
            layer.msg("您还未选择任何项！", { icon: 2 });
            return;
        }
        DealWithCounts("批量下架", "ToggleShelves", ids, false);
    })

    $("#btn_del").click(function () {
        var ids = [];
        $($("input[name='pass']:checked")).each(function () {
            ids.push($(this).val());
        })
        if (ids.length < 1) {
            layer.msg("您还未选择任何项！", { icon: 2 });
            return;
        }
        DealWithCounts("批量删除", "DeleteGoods", ids, false);
    })

    function DealWithCounts(msg, inter, goodsList ,isShelves) {
        layer.confirm('请确认' + msg + '选中的商品？', {
            btn: ['取消', '确认'] //按钮
        }, function () {
            layer.closeAll();
        }, function () {

            $.post("/GoodsManager/" + inter, { goodsIds: goodsList, isShelves: isShelves }, function (e) {
                if (e) {
                    layer.msg(msg + "成功！", { icon: 1 }, function () {
                        LoadList(index);
                    })
                    
                }
            }, "json");
        });
    }
    $(".J_midSoldNum").on("change", function () {
        var minCount = $(this).val();
        var goodsId = $(this).data("id");
        $.post("/GoodsManager/UpdateMinCount", { goodsId: goodsId, minCount: minCount }, function (e) {
            if (e) {
                LoadList(index);
            }
        },"json")
    })

    function ChangemidSoldNum(input)
    {
        var minCount = $(input).val();
        var goodsId = $(input).data("id");
        $.post("/GoodsManager/UpdateMinCount", { goodsId: goodsId, minCount: minCount }, function (e) {
            if (e) {
                LoadList(index);
            }
        }, "json")
    }

    
    function ChangeQuickSort(input)
    {
        var sortId = $(input).val();
        var goodsId = $(input).data("id");
        $.post("/GoodsManager/UpdateSortId", { goodsId: goodsId, sortId: sortId }, function (e) {
            if (e) {
                LoadList(index);
            }
        }, "json")
    }


    $(".J_QuickSort").on("change", function () {
        var sortId = $(this).val();
        var goodsId = $(this).data("id");
        $.post("/GoodsManager/UpdateSortId", { goodsId: goodsId, sortId: sortId }, function (e) {
            if (e) {
                LoadList(index);
            }
        }, "json")
    })
</script>
